<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scofield Analista - Plano Sombra</title>
<style>
  body {
    background-color: #121212;
    color: #eee;
    font-family: 'Consolas', monospace, monospace;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; min-height: 100vh;
  }
  header {
    background: #220000;
    padding: 1em;
    text-align: center;
    font-size: 1.5em;
    font-weight: bold;
    color: #f44336;
    user-select: none;
  }
  main {
    flex: 1;
    padding: 1em;
    max-width: 600px;
    margin: auto;
    display: flex;
    flex-direction: column;
    gap: 1em;
  }
  textarea {
    width: 100%;
    height: 120px;
    background: #222;
    border: none;
    border-radius: 4px;
    color: #eee;
    font-size: 1em;
    padding: 0.8em;
    resize: vertical;
  }
  label {
    font-weight: bold;
    color: #f44336;
  }
  button {
    background-color: #f44336;
    border: none;
    padding: 0.8em 1.2em;
    font-size: 1em;
    font-weight: bold;
    color: #fff;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #ff6659;
  }
  .btn-group {
    display: flex;
    gap: 0.8em;
    flex-wrap: wrap;
  }
  .output {
    background: #222;
    border-radius: 4px;
    padding: 1em;
    font-size: 1em;
    white-space: pre-wrap;
    min-height: 150px;
    color: #ddd;
  }
  .alert-strong {
    color: #ff3b3b;
    font-weight: bold;
  }
  .alert-weak {
    color: #ffa500;
    font-weight: bold;
  }
  .status {
    font-size: 0.9em;
    color: #aaa;
  }

  /* Layout pedras manual */
  .manual-container {
    display: flex;
    justify-content: center;
    gap: 1.5em;
    flex-wrap: wrap;
  }
  .pedra-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 90px;
  }
  .quadrado-cor {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    margin-bottom: 0.4em;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 40px;
    user-select: none;
  }
  .cor-preto {
    background-color: #222;
    border: 2px solid #555;
    color: #eee;
  }
  .cor-vermelho {
    background-color: #8b0000;
    border: 2px solid #b22222;
    color: #fff;
  }
  .cor-branco {
    background-color: #eee;
    border: 2px solid #ccc;
    color: #333;
    font-weight: bold;
  }
  /* Dado central */
  .dado {
    width: 80px;
    height: 80px;
    border-radius: 12px;
    background: linear-gradient(145deg, #eee, #ccc);
    border: 2px solid #aaa;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 48px;
    user-select: none;
    box-shadow: 1px 1px 6px #999 inset;
  }
  /* Inputs sob as pedras */
  .inputs-pedra {
    display: flex;
    flex-direction: column;
    gap: 0.3em;
    width: 80px;
  }
  input[type="text"], input[type="number"] {
    width: 100%;
    padding: 0.3em 0.5em;
    border-radius: 4px;
    border: none;
    font-size: 1em;
    background: #333;
    color: #eee;
  }
  input::placeholder {
    color: #aaa;
  }
</style>
</head>
<body>
<header>Scofield Analista - Plano Sombra</header>
<main>

<label for="historico">Cole aqui o histórico da Blaze (TipMiner):</label>
<textarea id="historico" placeholder="Exemplo:&#10;14:22:13 — ⚫️ 5&#10;14:21:01 — 🔴 9&#10;14:20:32 — ⚪️"></textarea>

<div class="btn-group" style="flex-wrap: nowrap; gap:0.6em;">
  <button id="btn-analisar-historico">Analisar Histórico</button>
  <button id="btn-limpar-tudo" style="background:#555;">Limpar Tudo</button>
</div>

<hr style="border-color:#333; margin:1em 0;" />

<label>Informe o sinal manual:</label>
<div class="manual-container">

  <div class="pedra-box" id="pedra-anterior">
    <div class="quadrado-cor cor-preto">⬛</div>
    <div class="inputs-pedra">
      <input type="number" id="manual-anterior-num" placeholder="Número" min="0" max="20" />
      <input type="text" id="manual-anterior-time" placeholder="HH:mm:ss" />
    </div>
  </div>

  <div class="pedra-box" id="pedra-branco">
    <div class="dado" title="Branco - dado 🎲">🎲</div>
    <div class="inputs-pedra">
      <input type="text" id="manual-branco-time" placeholder="HH:mm:ss" />
    </div>
  </div>

  <div class="pedra-box" id="pedra-posterior">
    <div class="quadrado-cor cor-vermelho">⬛</div>
    <div class="inputs-pedra">
      <input type="number" id="manual-posterior-num" placeholder="Número" min="0" max="20" />
      <input type="text" id="manual-posterior-time" placeholder="HH:mm:ss" />
    </div>
  </div>

</div>

<div class="btn-group" style="margin-top:0.8em;">
  <button id="btn-analisar-sinal">Analisar Sinal Manual</button>
</div>

<hr style="border-color:#333; margin:1em 0;" />

<div class="output" id="output"></div>

<div style="margin-top:1em;">
  <button id="btn-acertou" style="background:#2ecc71;" disabled>Acertou</button>
  <button id="btn-errou" style="background:#e74c3c;" disabled>Errou</button>
</div>

<div class="status" id="status"></div>

<script>
(() => {
  const historicoEl = document.getElementById('historico');
  const outputEl = document.getElementById('output');
  const statusEl = document.getElementById('status');

  const btnAnalisarHistorico = document.getElementById('btn-analisar-historico');
  const btnLimparTudo = document.getElementById('btn-limpar-tudo');
  const btnAnalisarSinal = document.getElementById('btn-analisar-sinal');
  const btnAcertou = document.getElementById('btn-acertou');
  const btnErrou = document.getElementById('btn-errou');

  const manualAnteriorNum = document.getElementById('manual-anterior-num');
  const manualAnteriorTime = document.getElementById('manual-anterior-time');
  const manualBrancoTime = document.getElementById('manual-branco-time');
  const manualPosteriorNum = document.getElementById('manual-posterior-num');
  const manualPosteriorTime = document.getElementById('manual-posterior-time');

  // --- Dados salvos ---
  let historicoDados = []; // array de objetos { horario: Date, cor: string, numero: number|null }
  let estrategias = []; // array de estratégias aprendidas
  let ultimoResultado = null; // resultado da última análise manual
  let pesosEstrategias = {}; // { idEstrategia: peso } - para ajustar por acertou/errou

  // --- Funções utilitárias ---

  // Parse de horário "HH:mm:ss" para Date do dia atual
  function parseHorario(horaStr) {
    const [h, m, s] = horaStr.split(':').map(x => parseInt(x,10));
    if (
      h>=0 && h<=23 &&
      m>=0 && m<=59 &&
      s>=0 && s<=59
    ) {
      const d = new Date();
      d.setHours(h, m, s, 0);
      return d;
    }
    return null;
  }

  // Formatar horário Date para "HH:mm:ss"
  function formatHorario(date) {
    return date.toTimeString().slice(0,8);
  }

  // Parsing linha do histórico
  // Exemplo linha: "14:22:13 — ⚫️ 5" ou "14:20:32 — ⚪️"
  function parseLinhaHistorico(linha) {
    linha = linha.trim();
    if(!linha) return null;

    const regex = /^(\d{2}:\d{2}:\d{2})\s*—\s*(⚫️|🔴|⚪️)(?:\s*(\d+))?$/u;
    const m = linha.match(regex);
    if(!m) return null;

    let cor = null;
    switch(m[2]){
      case '⚫️': cor='preto'; break;
      case '🔴': cor='vermelho'; break;
      case '⚪️': cor='branco'; break;
      default: cor=null;
    }
    const horario = parseHorario(m[1]);
    if(!horario) return null;

    const numero = m[3] !== undefined ? parseInt(m[3],10) : null;
    return { horario, cor, numero };
  }

  // Salvar estratégias no localStorage
  function salvarEstrategias() {
    localStorage.setItem('scofield_estrategias', JSON.stringify(estrategias));
    localStorage.setItem('scofield_pesos', JSON.stringify(pesosEstrategias));
  }
  // Carregar estratégias do localStorage
  function carregarEstrategias() {
    try {
      const est = JSON.parse(localStorage.getItem('scofield_estrategias'));
      if(Array.isArray(est)) estrategias = est;
      const pesos = JSON.parse(localStorage.getItem('scofield_pesos'));
      if(pesos && typeof pesos === 'object') pesosEstrategias = pesos;
    } catch {
      estrategias = [];
      pesosEstrategias = {};
    }
  }

  // Limpar tudo
  function limparTudo() {
    if(confirm("Deseja limpar todo histórico, estratégias e pesos?")) {
      historicoDados = [];
      estrategias = [];
      pesosEstrategias = {};
      ultimoResultado = null;
      salvarEstrategias();
      historicoEl.value = '';
      manualAnteriorNum.value = '';
      manualAnteriorTime.value = '';
      manualBrancoTime.value = '';
      manualPosteriorNum.value = '';
      manualPosteriorTime.value = '';
      btnAcertou.disabled = true;
      btnErrou.disabled = true;
      outputEl.textContent = '';
      statusEl.textContent = 'Dados limpos.';
    }
  }

  // Criar ID para estratégia
  function criarIdEstrategia(estrat) {
    return `soma:${estrat.soma};intervaloSeg:${estrat.intervaloSeg};cores:${estrat.cores.join(',')}`;
  }

  // Analisar histórico e gerar estratégias
  function analisarHistorico() {
    outputEl.textContent = 'Analisando histórico...';
    const linhas = historicoEl.value.split('\n');
    const dados = [];
    for(let linha of linhas){
      const p = parseLinhaHistorico(linha);
      if(p) dados.push(p);
    }
    if(dados.length < 3) {
      outputEl.textContent = 'Erro: histórico inválido ou incompleto (mínimo 3 linhas).';
      return;
    }
    historico
