<script>
  const app = document.getElementById('app');
  const resultados = JSON.parse(localStorage.getItem('resultados') || '[]');
  const feedbacks = JSON.parse(localStorage.getItem('feedbacks') || '{}');
  let ultimoPrevisto = null;

  function horaParaMinutos(hora) {
    const [h, m] = hora.split(':').map(Number);
    return h * 60 + m;
  }

  function minutosParaHora(minutos) {
    const h = String(Math.floor(minutos / 60)).padStart(2, '0');
    const m = String(minutos % 60).padStart(2, '0');
    return `${h}:${m}`;
  }

  function salvarResultado(esq, meio, dir) {
    if (!esq.numero || !esq.horario || !dir.numero || !dir.horario || !meio.horario) {
      alert('Preencha todos os n√∫meros e hor√°rios, exceto o branco que n√£o tem n√∫mero.');
      return;
    }
    resultados.push({ esq, meio, dir });
    localStorage.setItem('resultados', JSON.stringify(resultados));
    atualizarLog();
    alert('Resultado salvo com sucesso!');
  }

  function atualizarLog() {
    const logDiv = document.getElementById('log');
    if (resultados.length === 0) {
      logDiv.innerHTML = 'Nenhum resultado salvo ainda.';
      return;
    }
    logDiv.innerHTML = resultados.map((r, i) => {
      let feedback = feedbacks[i];
      let emoji = feedback === 'acerto' ? '‚úÖ' : feedback === 'erro' ? '‚ùå' : '';
      return `${i + 1}. ${r.esq.cor} ${r.esq.numero} ${r.esq.horario} | üé≤ ${r.meio.horario} | ${r.dir.cor} ${r.dir.numero} ${r.dir.horario} ${emoji}`;
    }).join('<br>');
  }

  function calcularConfian√ßa(media, intervalos, brancos) {
    if (brancos.length < 2) {
      return { text: "‚ö†Ô∏è Poucos dados ‚Äî sinal arriscado", color: "#f39c12" };
    } else if (media <= 4) {
      return { text: "‚úÖ Sinal forte ‚Äî branco prov√°vel", color: "#2ecc71" };
    } else {
      return { text: "‚ö†Ô∏è Sinal moderado ‚Äî use cautela", color: "#f1c40f" };
    }
  }

  function analisar() {
    if (resultados.length < 1) {
      alert('Salve pelo menos 1 resultado para come√ßar a an√°lise.');
      return;
    }

    const brancos = resultados
      .map(r => horaParaMinutos(r.meio.horario))
      .filter(v => v !== null)
      .sort((a, b) => a - b);

    if (brancos.length === 0) {
      alert('Nenhum hor√°rio v√°lido do branco encontrado para an√°lise.');
      return;
    }

    const ultimoBranco = brancos[brancos.length - 1];
    let mediaIntervalo = 6;

    if (brancos.length >= 2) {
      const intervalos = [];
      for (let i = 1; i < brancos.length; i++) {
        intervalos.push(brancos[i] - brancos[i - 1]);
      }
      mediaIntervalo = intervalos.reduce((a, b) => a + b, 0) / intervalos.length;
    }

    const previsto = Math.round(ultimoBranco + mediaIntervalo);
    const previstoHora = minutosParaHora(previsto);
    ultimoPrevisto = previsto;

    document.getElementById('resultado').textContent = `üïì PR√ìXIMO BRANCO PROV√ÅVEL EM ${previstoHora} ‚Äî PREPARA!`;

    const conf = calcularConfian√ßa(mediaIntervalo, [], brancos);
    document.getElementById('confian√ßa').textContent = conf.text;
    document.getElementById('confian√ßa').style.color = conf.color;

    // Mostrar bot√µes de feedback
    document.getElementById('avisos').innerHTML = `
      <button id="btnAcertou" style="margin-right:10px;">‚úÖ Acertou</button>
      <button id="btnErrou">‚ùå Errou</button>
    `;

    document.getElementById('btnAcertou').onclick = () => {
      feedbacks[resultados.length - 1] = 'acerto';
      localStorage.setItem('feedbacks', JSON.stringify(feedbacks));
      alert('Feedback de ACERTO registrado!');
      atualizarLog();
      document.getElementById('avisos').innerHTML = '';
    };

    document.getElementById('btnErrou').onclick = () => {
      feedbacks[resultados.length - 1] = 'erro';
      localStorage.setItem('feedbacks', JSON.stringify(feedbacks));
      alert('Feedback de ERRO registrado!');
      atualizarLog();
      document.getElementById('avisos').innerHTML = '';
    };
  }

  function limparHistorico() {
    if (!confirm('Tem certeza que deseja limpar todo o hist√≥rico?')) return;
    localStorage.removeItem('resultados');
    localStorage.removeItem('feedbacks');
    resultados.length = 0;
    for (const key in feedbacks) delete feedbacks[key];
    atualizarLog();
    document.getElementById('resultado').textContent = '';
    document.getElementById('confian√ßa').textContent = '';
    document.getElementById('avisos').textContent = '';
  }

  function criarInterface() {
    app.innerHTML = `
      <div class="container">
        <div class="pedra">
          <div contenteditable class="cor-quadrado" id="corEsq" title="Clique para mudar cor">üî¥</div>
          <label>N√∫mero</label>
          <input type="number" id="numEsq" />
          <label>Hor√°rio</label>
          <input type="time" id="horaEsq" />
        </div>
        <div class="pedra">
          <div class="cor-quadrado" id="corMeio" title="Branco - n√£o tem n√∫mero">üé≤</div>
          <label>Hor√°rio</label>
          <input type="time" id="horaMeio" />
        </div>
        <div class="pedra">
          <div contenteditable class="cor-quadrado" id="corDir" title="Clique para mudar cor">‚ö´</div>
          <label>N√∫mero</label>
          <input type="number" id="numDir" />
          <label>Hor√°rio</label>
          <input type="time" id="horaDir" />
        </div>
      </div>
      <button onclick="salvarResultado(
        {cor: document.getElementById('corEsq').textContent.trim(), numero: document.getElementById('numEsq').value.trim(), horario: document.getElementById('horaEsq').value},
        {horario: document.getElementById('horaMeio').value},
        {cor: document.getElementById('corDir').textContent.trim(), numero: document.getElementById('numDir').value.trim(), horario: document.getElementById('horaDir').value}
      )">Salvar Resultado</button>
      <button onclick="analisar()">Analisar</button>
      <button onclick="limparHistorico()">Limpar Hist√≥rico</button>
      <div id="resultado"></div>
      <div id="confian√ßa"></div>
      <div id="avisos"></div>
      <div id="log"></div>
    `;

    function toggleCor(element) {
      const cores = ['üî¥', '‚ö´', '‚ö™'];
      let atual = element.textContent.trim();
      let index = cores.indexOf(atual);
      index = (index + 1) % cores.length;
      element.textContent = cores[index];
    }

    document.getElementById('corEsq').addEventListener('click', e => toggleCor(e.target));
    document.getElementById('corDir').addEventListener('click', e => toggleCor(e.target));

    atualizarLog();
  }

  criarInterface();
</script>
</body>
</html>
