<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Scofield Analista com Feedback</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      color: #000;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h1 {
      margin-bottom: 20px;
    }
    .container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .pedra {
      width: 130px;
      height: 170px;
      border: 3px solid #999;
      border-radius: 14px;
      text-align: center;
      padding: 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      user-select: none;
    }
    .quadrado-cor {
      width: 100%;
      height: 130px;
      border-radius: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 70px;
      color: white;
      user-select: none;
    }
    .vermelho { background-color: #c0392b; }
    .preto { background-color: #000; }
    .branco {
      background-color: #ecf0f1;
      color: #000;
      position: relative;
    }
    .blaze-logo {
      width: 65px;
      height: 65px;
      margin: auto;
      background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Blaze_logo.svg/512px-Blaze_logo.svg.png') no-repeat center center;
      background-size: contain;
      pointer-events: none;
    }
    label {
      font-weight: bold;
      font-size: 15px;
      margin-top: 5px;
      user-select: none;
    }
    input[type=number], input[type=time] {
      width: 100%;
      font-size: 17px;
      padding: 5px;
      border-radius: 7px;
      border: 1.5px solid #888;
      text-align: center;
      user-select: text;
    }
    button {
      padding: 14px 32px;
      font-size: 19px;
      border: none;
      background-color: #c0392b;
      color: white;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 12px;
      margin-right: 12px;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #e74c3c;
    }
    #log {
      max-height: 300px;
      overflow-y: auto;
      width: 100%;
      max-width: 660px;
      background: #f0f0f0;
      padding: 18px;
      border-radius: 14px;
      font-size: 16px;
      margin-top: 30px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      user-select: none;
    }
    .log-item {
      margin-bottom: 15px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 8px;
    }
    #resultado {
      margin-top: 28px;
      font-weight: 700;
      font-size: 22px;
      color: #d63031;
      max-width: 660px;
      text-align: center;
      user-select: none;
    }
    #status {
      margin-top: 10px;
      font-weight: 600;
      font-size: 20px;
      user-select: none;
    }
    #status.forte {
      color: #27ae60;
    }
    #status.arriscado {
      color: #f39c12;
    }
    #status.fraco {
      color: #7f8c8d;
    }
    #feedback-area {
      margin-top: 20px;
      text-align: center;
      user-select: none;
    }
    #feedback-area button {
      background-color: #2980b9;
      margin: 8px;
    }
  </style>
</head>
<body>

  <h1>Scofield Analista com Feedback</h1>

  <div class="container">
    <div class="pedra" id="pedra-esq">
      <div class="quadrado-cor vermelho" id="cor-esq" title="Clique para mudar a cor">🔴</div>
      <label for="num-esq">Número</label>
      <input type="number" id="num-esq" min="0" max="14" />
      <label for="hora-esq">Horário</label>
      <input type="time" id="hora-esq" />
    </div>

    <div class="pedra" id="pedra-meio">
      <div class="quadrado-cor branco" id="cor-meio" title="Branco (Blaze)">
        <div class="blaze-logo"></div>
      </div>
      <label for="hora-meio">Horário Branco</label>
      <input type="time" id="hora-meio" />
    </div>

    <div class="pedra" id="pedra-dir">
      <div class="quadrado-cor vermelho" id="cor-dir" title="Clique para mudar a cor">🔴</div>
      <label for="num-dir">Número</label>
      <input type="number" id="num-dir" min="0" max="14" />
      <label for="hora-dir">Horário</label>
      <input type="time" id="hora-dir" />
    </div>
  </div>

  <div>
    <button id="btn-salvar">Salvar Resultado</button>
    <button id="btn-analisar">Analisar</button>
    <button id="btn-limpar" style="background:#555;">🧼 Limpar Histórico</button>
  </div>

  <div id="resultado"></div>
  <div id="status"></div>

  <div id="feedback-area" style="display:none;">
    <p>Acertou a previsão?</p>
    <button id="btn-feedback-sim">Sim</button>
    <button id="btn-feedback-nao">Não</button>
  </div>

  <div id="log"></div>

  <script>
    const cores = ['vermelho', 'preto'];
    const corEsqDiv = document.getElementById('cor-esq');
    const corDirDiv = document.getElementById('cor-dir');
    let corEsqIndex = 0;
    let corDirIndex = 0;

    function atualizaCor(div, index) {
      div.className = 'quadrado-cor ' + cores[index];
      div.textContent = cores[index] === 'vermelho' ? '🔴' : '⚫';
    }

    corEsqDiv.addEventListener('click', () => {
      corEsqIndex = (corEsqIndex + 1) % cores.length;
      atualizaCor(corEsqDiv, corEsqIndex);
    });

    corDirDiv.addEventListener('click', () => {
      corDirIndex = (corDirIndex + 1) % cores.length;
      atualizaCor(corDirDiv, corDirIndex);
    });

    // Pesos iniciais para padrões e soma (ajustáveis via feedback)
    let pesos = {
      somaMax: 40,
      ptsDuplo: 30,
      ptsDentado: 20,
      ptsBanguela: 10
    };

    // Histórico e resultados guardados localmente
    let resultados = JSON.parse(localStorage.getItem('resultados')) || [];
    let feedbacks = JSON.parse(localStorage.getItem('feedbacks')) || [];
    let taxaAcerto = localStorage.getItem('taxaAcerto') || 0;

    function salvaResultado() {
      const numEsq = Number(document.getElementById('num-esq').value);
      const horaEsq = document.getElementById('hora-esq').value;
      const horaMeio = document.getElementById('hora-meio').value;
      const numDir = Number(document.getElementById('num-dir').value);
      const horaDir = document.getElementById('hora-dir').value;

      if (
        isNaN(numEsq) || isNaN(numDir) ||
        !horaEsq || !horaMeio || !horaDir
      ) {
        alert('Preencha todos os campos corretamente.');
        return;
      }

      resultados.push({
        esquerda: { cor: cores[corEsqIndex], numero: numEsq, horario: horaEsq },
        meio: { cor: 'branco', horario: horaMeio },
        direita: { cor: cores[corDirIndex], numero: numDir, horario: horaDir }
      });

      localStorage.setItem('resultados', JSON.stringify(resultados));
      atualizaLog();
      limpaFormulario();
      document.getElementById('resultado').textContent = '';
      document.getElementById('status').textContent = '';
      document.getElementById('status').className = '';
      document.getElementById('feedback-area').style.display = 'none';
    }

    function atualizaLog() {
      const logDiv = document.getElementById('log');
      if(resultados.length === 0) {
        logDiv.innerHTML = '<p>Nenhum resultado salvo.</p>';
        return;
      }
      let html = '';
      resultados.forEach((r, i) => {
        html += `<div class="log-item">
          <strong>Registro ${i+1}</strong><br>
          🟥 Esquerda: ${r.esquerda.cor} | Nº: ${r.esquerda.numero} | Hora: ${r.esquerda.horario}<br>
          ⚪ Branco: ${r.meio.horario}<br>
          ⬛ Direita: ${r.direita.cor} | Nº: ${r.direita.numero} | Hora: ${r.direita.horario}
        </div>`;
      });
      logDiv.innerHTML = html;
    }

    function limpaFormulario() {
      document.getElementById('num-esq').value = '';
      document.getElementById('hora-esq').value = '';
      document.getElementById('hora-meio').value = '';
      document.getElementById('num-dir').value = '';
      document.getElementById('hora-dir').value = '';
    }

    function horaParaMinutos(hora) {
      const [h, m] = hora.split(':').map(Number);
      return h * 60 + m;
    }

    function minutosParaHora(min) {
      const h = String(Math.floor(min / 60)).padStart(2, '0');
      const m = String(min % 60).padStart(2, '0');
      return `${h}:${m}`;
    }

    // Detecta padrões (Duplo, Dentado, Banguela)
    function detectarPadroesBranco() {
      const brancos = resultados.map((r, i) => ({
        index: i,
        horarioMin: horaParaMinutos(r.meio.horario)
      })).sort((a,b) => a.horarioMin - b.horarioMin);

      let padroes = [];
      for(let i=0; i < brancos.length -1; i++) {
        const diff = brancos[i+1].horarioMin - brancos[i].horarioMin;
        if(diff === 1) padroes.push('duplo');
        else if(diff === 2) padroes.push('dentado');
        else if(diff <= 4) padroes.push('banguela');
        else padroes.push('nenhum');
      }
      return padroes;
    }

    function mediaIntervaloBrancos() {
      const brancos = resultados.map(r => horaParaMinutos(r.meio.horario)).sort((a,b) => a-b);
      if(brancos.length < 2) return null;
      let soma = 0;
      for(let i=1; i < brancos.length; i++) {
        soma += brancos[i] - brancos[i-1];
      }
      return soma / (brancos.length -1);
    }

    // Calcula confiança com pesos ajustados
    function calcularConfianca(resultado, padrao) {
      const somaNums = resultado.esquerda.numero + resultado.direita.numero;
      let ptsSoma = Math.min(somaNums * 2, pesos.somaMax);

      let ptsPadrao = 0;
      if(padrao === 'duplo') ptsPadrao = pesos.ptsDuplo;
      else if(padrao === 'dentado') ptsPadrao = pesos.ptsDentado;
      else if(padrao === 'banguela') ptsPadrao = pesos.ptsBanguela;

      const media = mediaIntervaloBrancos();
      let ptsIntervalo = 0;
      if(media !== null && resultados.length > 1) {
        const diffAtual = horaParaMinutos(resultado.meio.horario) - horaParaMinutos(resultados[resultados.length - 2].meio.horario);
        const difAbs = Math.abs(diffAtual - media);
        ptsIntervalo = Math.max(0, 30 - difAbs * 10);
      }

      const total = ptsSoma + ptsPadrao + ptsIntervalo;
      return Math.min(total, 100);
    }

    // Previsão do próximo branco
    function preverProximoBranco() {
      const media = mediaIntervaloBrancos();
      if(media === null) return 'Dados insuficientes para previsão.';
      const ultBranco = horaParaMinutos(resultados[resultados.length - 1].meio.horario);
      const previsto = Math.round(ultBranco + media);
      return minutosParaHora(previsto);
    }

    // Mostra análise e ativa feedback
    function analisarDados() {
      if(resultados.length === 0) {
        alert('Nenhum dado para analisar.');
        return;
      }

      const padroes = detectarPadroesBranco();
      const ultimoPadrao = padroes.length > 0 ? padroes[padroes.length - 1] : 'nenhum';
      const ultimoResultado = resultados[resultados.length - 1];
      const confianca = calcularConfianca(ultimoResultado, ultimoPadrao);

      let statusTexto = '';
      let statusClass = '';
      if(confianca >= 75) {
        statusTexto = 'FORTE — Prepare-se!';
        statusClass = 'forte';
        playAlerta();
      } else if(confianca >= 40) {
        statusTexto = 'ARRISCADO — Fique atento.';
        statusClass = 'arriscado';
      } else {
        statusTexto = 'FRACO — Baixa confiança.';
        statusClass = 'fraco';
      }

      const proxBrancoHora = preverProximoBranco();
      const frase = `🕓 PRÓXIMO BRANCO PROVÁVEL EM ${proxBrancoHora} — PREPARA!`;

      document.getElementById('resultado').textContent = frase;
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = statusTexto;
      statusDiv.className = statusClass;

      // Exibe feedback
      document.getElementById('feedback-area').style.display = 'block';
    }

    // Ajusta pesos com base no feedback
    function ajustarPesos(acertou) {
      const delta = 2;
      if(acertou) {
        pesos.somaMax = Math.min(pesos.somaMax + delta, 50);
        pesos.ptsDuplo = Math.min(pesos.ptsDuplo + delta, 40);
        pesos.ptsDentado = Math.min(pesos.ptsDentado + delta, 30);
        pesos.ptsBanguela = Math.min(pesos.ptsBanguela + delta, 20);
      } else {
        pesos.somaMax = Math.max(pesos.somaMax - delta, 20);
        pesos.ptsDuplo = Math.max(pesos.ptsDuplo - delta, 10);
        pesos.ptsDentado = Math.max(pesos.ptsDentado - delta, 5);
        pesos.ptsBanguela = Math.max(pesos.ptsBanguela - delta, 0);
      }
      salvarPesos();
    }

    function salvarPesos() {
      localStorage.setItem('pesos', JSON.stringify(pesos));
    }

    function carregarPesos() {
      const p = JSON.parse(localStorage.getItem('pesos'));
      if(p) {
        pesos = p;
      }
    }

    // Registra feedback, atualiza taxa de acerto e pesos
    function registrarFeedback(acertou) {
      feedbacks.push(acertou);
      localStorage.setItem('feedbacks', JSON.stringify(feedbacks));
      const total = feedbacks.length;
      const acertos = feedbacks.filter(f => f).length;
      taxaAcerto = (acertos / total) * 100;
      localStorage.setItem('taxaAcerto', taxaAcerto);
      ajustarPesos(acertou);
      alert(`Feedback registrado! Taxa de acerto atual: ${taxaAcerto.toFixed(2)}%`);
      document.getElementById('feedback-area').style.display = 'none';
      document.getElementById('resultado').textContent = '';
      document.getElementById('status').textContent = '';
      document.getElementById('status').className = '';
    }

    function playAlerta() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        osc.type = 'square';
        osc.frequency.setValueAtTime(660, ctx.currentTime);
        osc.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.7);
      } catch {}
    }

    document.getElementById('btn-salvar').addEventListener('click', salvaResultado);
    document.getElementById('btn-analisar').addEventListener('click', analisarDados);
    document.getElementById('btn-limpar').addEventListener('click', () => {
      if(confirm("Tem certeza que quer apagar todo o histórico?")) {
        resultados = [];
        feedbacks = [];
        taxaAcerto = 0
