<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scofield Analista PRO ‚ö™ - TURBINADO</title>
<style>
  body {
    background: #111; color: #eee; font-family: 'Segoe UI', sans-serif; padding: 15px;
  }
  h1 { text-align: center; color: #ff4747; }
  textarea, input, button {
    width: 100%; padding: 10px; margin: 5px 0;
    border-radius: 5px; box-sizing: border-box;
  }
  textarea, input {
    background: #222; color: #eee; border: 1px solid #555;
  }
  button {
    background: #ff4747; color: white; border: none; cursor: pointer;
  }
  button:hover { background: #e53e3e; }
  .secao { margin-top: 25px; }
  .sinal {
    background: #222; padding: 10px; margin-top: 10px;
    border-radius: 5px;
  }
  .sinal button {
    width: 48%; margin: 2px 1%; font-weight: bold;
  }
  .estatisticas {
    white-space: pre-line;
    background: #222;
    padding: 10px;
    border-radius: 5px;
    margin-top: 15px;
    font-size: 1em;
    max-height: 200px;
    overflow-y: auto;
  }
  #contadorEstrategias {
    font-weight: bold;
    margin-top: 10px;
    color: #ff6666;
  }
  #mensagemCerebro, #mensagemHistorico {
    margin-top: 5px;
    color: #8f8;
  }
</style>
</head>
<body>

<h1>Scofield Analista PRO ‚ö™ - TURBINADO</h1>

<div class="secao">
  <h3>üß† Hist√≥rico C√©rebro</h3>
  <textarea id="historicoCerebro" rows="8" placeholder="Cole aqui o hist√≥rico completo com pedras, hor√°rios e brancos... (3 linhas por conjunto)"></textarea>
  <button onclick="enviarCerebro()">üì§ Enviar Hist√≥rico</button>
  <div id="mensagemCerebro"></div>
  <div id="contadorEstrategias">Estrat√©gias criadas: 0</div>
</div>

<div class="secao">
  <h3>‚è±Ô∏è Come√ßar An√°lise</h3>
  <textarea id="historicoAtual" rows="6" placeholder="Cole aqui as √∫ltimas 3 linhas: pedra anterior, hor√°rio branco, pedra posterior"></textarea>
  <button onclick="analisarAgora()">üîç Analisar</button>
  <div id="previsoes"></div>
</div>

<div class="secao">
  <h3>üìä Estat√≠sticas</h3>
  <div id="estatisticas" class="estatisticas">Nenhuma estat√≠stica registrada ainda.</div>
  <button onclick="limparEstatisticas()">üßπ Limpar Estat√≠sticas</button>
</div>

<div class="secao">
  <h3>üßπ Limpar Hist√≥rico</h3>
  <button onclick="limparHistorico()">üßº Limpar Campos de Hist√≥rico</button>
  <div id="mensagemHistorico"></div>
</div>

<script>
  // Dados persistidos
  let estrategias = JSON.parse(localStorage.getItem("estrategias") || "[]");
  let estatisticas = JSON.parse(localStorage.getItem("estatisticas") || "[]");

  // Atualiza contador estrat√©gias
  function atualizarContador() {
    document.getElementById("contadorEstrategias").innerText = `Estrat√©gias criadas: ${estrategias.length}`;
  }

  // Salva dados no localStorage e atualiza UI
  function salvarDados() {
    localStorage.setItem("estrategias", JSON.stringify(estrategias));
    localStorage.setItem("estatisticas", JSON.stringify(estatisticas));
    atualizarEstatisticas();
    atualizarContador();
  }

  // Converte hor√°rio "HH:MM:SS" para segundos do dia
  function horarioParaSegundos(horario) {
    const [h,m,s] = horario.split(":").map(Number);
    return h*3600 + m*60 + s;
  }

  // Converte segundos para "HH:MM:SS"
  function segundosParaHorario(segundos) {
    const h = Math.floor(segundos/3600)%24;
    const m = Math.floor((segundos%3600)/60);
    const s = segundos%60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  // Fun√ß√£o para comparar padr√µes hist√≥ricos: sequ√™ncias de somas e hor√°rios
  function compararPadroes(padrao1, padrao2) {
    if(padrao1.length !== padrao2.length) return false;
    for(let i=0; i<padrao1.length; i++){
      if(padrao1[i].soma !== padrao2[i].soma) return false;
      // Permite at√© 60s diferen√ßa no hor√°rio (ex: toler√¢ncia)
      if(Math.abs(horarioParaSegundos(padrao1[i].horario) - horarioParaSegundos(padrao2[i].horario)) > 60) return false;
    }
    return true;
  }

  // Extrair padr√µes do hist√≥rico c√©rebro
  function extrairPadroesDoHistorico(texto) {
    let linhas = texto.trim().split(/\r?\n/).filter(l => l.trim() !== "");
    let padrao = [];

    for(let i=0; i+2 < linhas.length; i+=3){
      let pedraAnterior = parseInt(linhas[i]);
      let horarioBranco = linhas[i+1];
      let pedraPosterior = parseInt(linhas[i+2]);
      if(isNaN(pedraAnterior) || isNaN(pedraPosterior)) continue;
      if(!horarioBranco.match(/^\d{2}:\d{2}:\d{2}$/)) continue;
      padrao.push({ soma: pedraAnterior + pedraPosterior, horario: horarioBranco });
    }
    return padrao;
  }

  // Salva ou atualiza estrat√©gia baseada no padr√£o
  function salvarOuAtualizarEstrategia(novoPadrao) {
    // Tenta achar padr√£o parecido j√° salvo
    for(let est of estrategias){
      if(compararPadroes(est.padrao, novoPadrao)){
        // Atualiza hor√°rios se houver algum hor√°rio novo
        novoPadrao.forEach(np => {
          if(!est.horarios.includes(np.horario)) est.horarios.push(np.horario);
        });
        return false; // N√£o criou nova estrat√©gia
      }
    }
    // Se n√£o achou padr√£o, cria nova estrat√©gia
    estrategias.push({
      padrao: novoPadrao,
      horarios: novoPadrao.map(p => p.horario),
      peso: 1
    });
    return true; // Criou nova estrat√©gia
  }

  // Enviar hist√≥rico c√©rebro, extrair padr√£o e salvar estrat√©gia
  function enviarCerebro() {
    const texto = document.getElementById("historicoCerebro").value;
    if(texto.trim().length < 10){
      alert("Hist√≥rico muito curto.");
      return;
    }
    const padrao = extrairPadroesDoHistorico(texto);
    if(padrao.length === 0){
      alert("Formato do hist√≥rico c√©rebro inv√°lido.");
      return;
    }
    const criouNova = salvarOuAtualizarEstrategia(padrao);
    document.getElementById("mensagemCerebro").innerText = criouNova ? 
      "‚úÖ Hist√≥rico enviado e nova estrat√©gia criada!" :
      "‚úÖ Hist√≥rico enviado e estrat√©gia existente atualizada!";
    salvarDados();
  }

  // Detectar REC ou CHUVA com base em padr√µes similares no hist√≥rico
  function detectarRecOuChuva(padraoAtual) {
    // Vamos analisar o padr√£o atual e comparar com hist√≥ricos salvos para:
    // - Detectar per√≠odos longos sem brancos (REC)
    // - Detectar per√≠odos com muitos brancos pr√≥ximos (CHUVA)
    // Se encontrar padr√£o semelhante, retorna aviso, sen√£o vazio

    for(let est of estrategias){
      if(compararPadroes(est.padrao, padraoAtual)){
        // Analisar espa√ßamento dos hor√°rios no padr√£o
        const segs = est.padrao.map(p => horarioParaSegundos(p.horario));
        let intervalos = [];
        for(let i=1; i<segs.length; i++){
          intervalos.push(segs[i] - segs[i-1]);
        }
        const mediaIntervalo = intervalos.reduce((a,b)=>a+b,0) / intervalos.length;

        if(mediaIntervalo > 600){ // mais de 10 minutos entre brancos: REC detectado
          return "‚ö†Ô∏è REC detectado: per√≠odo com poucos brancos e intervalo longo.";
        }
        if(mediaIntervalo < 180){ // menos de 3 minutos: CHUVA detectada
          return "‚ö†Ô∏è CHUVA de brancos detectada: v√°rios brancos pr√≥ximos.";
        }
        return ""; // Nenhuma anormalidade detectada
      }
    }
    return "";
  }

  // Analisar o hist√≥rico atual, prever pr√≥ximos brancos
  function analisarAgora() {
    const texto = document.getElementById("historicoAtual").value.trim();
    let linhas = texto.split(/\r?\n/).filter(l => l.trim() !== "");
    if(linhas.length < 3){
      alert("Cole ao menos 3 linhas: pedra anterior, hor√°rio do branco, pedra posterior.");
      return;
    }
    const pedraAnterior = parseInt(linhas[0]);
    const horarioAtual = linhas[1];
    const pedraPosterior = parseInt(linhas[2]);

    if(isNaN(pedraAnterior) || isNaN(pedraPosterior) || !horarioAtual.match(/^\d{2}:\d{2}:\d{2}$/)){
      alert("Formato inv√°lido no hist√≥rico atual.");
      return;
    }
    const somaAtual = pedraAnterior + pedraPosterior;

    // Tenta encontrar estrat√©gias compat√≠veis para essa soma atual
    let estrategiasValidas = estrategias.filter(e => e.padrao.some(p => p.soma === somaAtual));

    const divPrevisoes = document.getElementById("previsoes");
    divPrevisoes.innerHTML = "";

    if(estrategiasValidas.length === 0){
      divPrevisoes.innerHTML = "<p>üîç Nenhuma estrat√©gia encontrada para essa soma no hist√≥rico c√©rebro.</p>";
      return;
    }

    // Montar o padr√£o atual (somente 1 elemento) para passar na fun√ß√£o de detec√ß√£o rec/chuva
    const padraoAtual = [{ soma: somaAtual, horario: horarioAtual }];

    // Verifica rec ou chuva no padr√£o atual
    const avisoRecChuva = detectarRecOuChuva(padraoAtual);

    // Exibir aviso se houver
    if(avisoRecChuva){
      const avisoDiv = document.createElement("div");
      avisoDiv.style.color = "#ff4444";
      avisoDiv.style.fontWeight = "bold";
      avisoDiv.style.marginBottom = "10px";
      avisoDiv.innerText = avisoRecChuva;
      divPrevisoes.appendChild(avisoDiv);
    }

    // Exibir previs√µes reais (todos os hor√°rios das estrat√©gias encontradas que contenham soma atual)
    estrategiasValidas.forEach(estrat => {
      estrat.padrao.forEach(p => {
        if(p.soma === somaAtual){
          const sinalDiv = document.createElement("div");
          sinalDiv.className = "sinal";
          sinalDiv.innerHTML = `
            <strong>${p.horario}</strong> (Peso: ${estrat.peso})<br>
            <button onclick="registrarResultado('${p.horario}', 'win', ${estrat.peso}, ${estrategias.indexOf(estrat)})">‚úÖ Acertou</button>
            <button onclick="registrarResultado('${p.horario}', 'loss', ${estrat.peso}, ${estrategias.indexOf(estrat)})">‚ùå Errou</button>
          `;
          divPrevisoes.appendChild(sinalDiv);
        }
      });
    });
  }

  // Registrar resultado e ajustar peso da estrat√©gia
  function registrarResultado(horario, resultado, peso, idxEstrat) {
    if(idxEstrat === undefined || idxEstrat < 0 || idxEstrat >= estrategias.length) return;

    if(resultado === 'win'){
      estrategias[idxEstrat].peso = (estrategias[idxEstrat].peso || 1) + 1;
    } else if(resultado === 'loss'){
      estrategias[idxEstrat].peso = Math.max((estrategias[idxEstrat].peso || 1) - 1, 1);
    }

    estatisticas.push({ horario, resultado: resultado === 'win' ? '‚úÖ' : '‚ùå', timestamp: new Date().toISOString() });
    salvarDados();
  }

  // Atualizar estat√≠sticas
  function atualizarEstatisticas() {
    const div = document.getElementById("estatisticas");
    if(estatisticas.length === 0){
      div.innerText = "Nenhuma estat√≠stica registrada ainda.";
      return;
    }
    div.innerText = estatisticas
      .slice().reverse()
      .map(e => `${e.horario} ${e.resultado}`)
      .join("\n");
  }

  // Limpar estat√≠sticas
  function limparEstatisticas() {
    if(confirm("Tem certeza que deseja apagar as estat√≠sticas?")){
      estatisticas = [];
      salvarDados();
    }
  }

  // Limpar hist√≥rico e mensagens
  function limparHistorico() {
    document.getElementById("historicoCerebro").value = "";
    document.getElementById("historicoAtual").value = "";
    document.getElementById("mensagemCerebro").innerText = "";
    document.getElementById("previsoes").innerHTML = "";
    document.getElementById("mensagemHistorico").innerText = "‚úÖ Campos de hist√≥rico limpos! Estrat√©gias mantidas.";
  }

  // Inicializa√ß√£o UI
  atualizarEstatisticas();
  atualizarContador();
</script>
</body>
</html>
