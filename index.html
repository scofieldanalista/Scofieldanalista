<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scofield Analista - Plano Sombra</title>
<style>
  body {
    background: #121212;
    color: #eee;
    font-family: 'Consolas', monospace;
    margin: 0; padding: 1rem;
  }
  textarea, input {
    font-family: monospace;
    font-size: 1rem;
    margin: 0.3rem 0;
    width: 100%;
    box-sizing: border-box;
  }
  button {
    background: #e74c3c;
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    font-weight: bold;
    cursor: pointer;
    margin: 0.3rem 0.1rem;
    border-radius: 4px;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  .status {
    margin-top: 0.5rem;
    font-weight: bold;
  }
  .quadrados {
    display: flex;
    justify-content: space-around;
    margin-top: 1rem;
  }
  .quadrado {
    width: 80px;
    height: 80px;
    border-radius: 12px;
    color: white;
    font-size: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .preto { background: #222; }
  .vermelho { background: #c0392b; }
  .branco {
    background: #ddd;
    color: #333;
    font-size: 3.5rem;
    font-weight: bold;
  }
  label {
    display: block;
    margin-top: 0.6rem;
  }
  .resultado {
    margin-top: 1rem;
    background: #222;
    padding: 1rem;
    border-radius: 8px;
    min-height: 80px;
    white-space: pre-wrap;
  }
</style>
</head>
<body>

<h2>Scofield Analista - Plano Sombra</h2>

<label for="inputHistorico">Cole aqui o hist√≥rico (formato TipMiner):</label>
<textarea id="inputHistorico" rows="10" placeholder="15/07/2025 19:14:55 ‚Äî ‚ö´Ô∏è 8
15/07/2025 19:14:25 ‚Äî üî¥ 10
15/07/2025 19:13:55 ‚Äî ‚ö™Ô∏è
..."></textarea>
<button id="btnAnalisarHistorico">Analisar Hist√≥rico</button>
<div id="statusHistorico" class="status"></div>

<div class="quadrados" style="margin-top:1rem;">
  <div class="quadrado preto" id="corAnterior">‚ö´Ô∏è</div>
  <div class="quadrado branco" id="corBranco">üé≤</div>
  <div class="quadrado vermelho" id="corPosterior">üî¥</div>
</div>

<div style="display:flex; gap:1rem; margin-top:0.5rem;">
  <div style="flex:1;">
    <label>Pedra Anterior - N√∫mero:</label>
    <input type="number" id="inputNumAnterior" min="0" max="50" />
    <label>Hor√°rio (HH:mm:ss):</label>
    <input type="text" id="inputHoraAnterior" placeholder="19:14:55" />
  </div>
  <div style="flex:1;">
    <label>Branco - Hor√°rio (HH:mm:ss):</label>
    <input type="text" id="inputHoraBranco" placeholder="19:14:55" />
  </div>
  <div style="flex:1;">
    <label>Pedra Posterior - N√∫mero:</label>
    <input type="number" id="inputNumPosterior" min="0" max="50" />
    <label>Hor√°rio (HH:mm:ss):</label>
    <input type="text" id="inputHoraPosterior" placeholder="19:14:55" />
  </div>
</div>

<button id="btnAnalisarSinal" style="margin-top: 1rem;">Analisar Sinal Manual</button>

<div id="resultado" class="resultado"></div>

<div style="margin-top: 1rem;">
  <button id="btnAcertou" disabled>Acertou üëç</button>
  <button id="btnErrou" disabled>Errou ‚ö†Ô∏è</button>
  <button id="btnLimparTudo">Limpar Tudo</button>
</div>

<div id="statusGeral" class="status"></div>

<script>
(() => {
  // Vari√°veis
  let estrategias = [];
  let pesosEstrategias = {};
  let ultimoResultado = null;

  // Elementos DOM
  const inputHistorico = document.getElementById('inputHistorico');
  const btnAnalisarHistorico = document.getElementById('btnAnalisarHistorico');
  const statusHistorico = document.getElementById('statusHistorico');
  const resultadoEl = document.getElementById('resultado');
  const btnAnalisarSinal = document.getElementById('btnAnalisarSinal');
  const btnAcertou = document.getElementById('btnAcertou');
  const btnErrou = document.getElementById('btnErrou');
  const btnLimparTudo = document.getElementById('btnLimparTudo');
  const statusGeral = document.getElementById('statusGeral');

  // Parse hor√°rio HH:mm:ss para Date
  function parseHorario(hhmmss) {
    if (!hhmmss) return null;
    const now = new Date();
    const [h,m,s] = hhmmss.split(':').map(x => parseInt(x));
    if ([h,m,s].some(isNaN)) return null;
    now.setHours(h, m, s, 0);
    return now;
  }

  // Parse hist√≥rico TipMiner formatado "15/07/2025 19:14:55 ‚Äî ‚ö´Ô∏è 8"
  function parseHistoricoTipMiner(texto) {
    const linhas = texto.split('\n');
    const pedras = [];

    for (const linha of linhas) {
      if (!linha.trim()) continue;
      if (!linha.includes(' ‚Äî ')) continue;

      const [dataHoraStr, corNumStr] = linha.split(' ‚Äî ');
      if (!dataHoraStr || !corNumStr) continue;

      // Extrai data e hora
      // Exemplo: "15/07/2025 19:14:55"
      // Convertendo para Date (UTC local)
      const dtParts = dataHoraStr.trim().split(' ');
      if (dtParts.length !== 2) continue;
      const [dataStr, horaStr] = dtParts;

      // Converte data para formato ISO yyyy-MM-dd
      const [dia, mes, ano] = dataStr.split('/');
      if (!dia || !mes || !ano) continue;
      const dataISO = `${ano}-${mes.padStart(2,'0')}-${dia.padStart(2,'0')}T${horaStr}`;

      // Cria objeto Date
      const dt = new Date(dataISO);

      // Determina cor e n√∫mero
      let cor = null;
      let numero = null;
      if (corNumStr.startsWith('‚ö´Ô∏è')) {
        cor = 'preto';
        numero = parseInt(corNumStr.slice(2).trim());
      } else if (corNumStr.startsWith('üî¥')) {
        cor = 'vermelho';
        numero = parseInt(corNumStr.slice(2).trim());
      } else if (corNumStr.startsWith('‚ö™Ô∏è')) {
        cor = 'branco';
        numero = null;
      } else {
        continue;
      }

      pedras.push({
        dataHora: dt,
        cor,
        numero
      });
    }
    return pedras;
  }

  // Salvar estrat√©gias no localStorage
  function salvarEstrategias() {
    localStorage.setItem('estrategias', JSON.stringify(estrategias));
    localStorage.setItem('pesosEstrategias', JSON.stringify(pesosEstrategias));
  }

  // Carregar estrat√©gias do localStorage
  function carregarEstrategias() {
    const estStr = localStorage.getItem('estrategias');
    const pesosStr = localStorage.getItem('pesosEstrategias');
    estrategias = estStr ? JSON.parse(estStr) : [];
    pesosEstrategias = pesosStr ? JSON.parse(pesosStr) : {};
  }

  // Criar estrat√©gias baseadas nas pedras (soma anterior+posterior, intervalo, cores)
  function criarEstrategias(pedras) {
    estrategias = [];
    // Vamos analisar brancos e suas pedras anterior e posterior
    for (let i = 1; i < pedras.length - 1; i++) {
      if (pedras[i].cor === 'branco') {
        const anterior = pedras[i-1];
        const posterior = pedras[i+1];
        if (!anterior || !posterior) continue;
        if (anterior.numero == null || posterior.numero == null) continue;

        const soma = anterior.numero + posterior.numero;
        const intervaloSeg = (posterior.dataHora - pedras[i].dataHora) / 1000;

        estrategias.push({
          id: estrategias.length,
          soma,
          intervaloSeg,
          cores: [anterior.cor, 'branco', posterior.cor],
          peso: pesosEstrategias[estrategias.length] ?? 1
        });
      }
    }
    salvarEstrategias();
  }

  // Analisar hist√≥rico
  function analisarHistorico() {
    const texto = inputHistorico.value.trim();
    if (!texto) {
      statusHistorico.textContent = '‚ö†Ô∏è Cole o hist√≥rico primeiro.';
      statusHistorico.style.color = '#e74c3c';
      return;
    }
    const pedras = parseHistoricoTipMiner(texto);
    if (pedras.length < 3) {
      statusHistorico.textContent = '‚ö†Ô∏è Hist√≥rico inv√°lido ou incompleto (m√≠nimo 3 linhas v√°lidas).';
      statusHistorico.style.color = '#e74c3c';
      return;
    }

    criarEstrategias(pedras);
    statusHistorico.textContent = '‚úÖ Hist√≥rico analisado com sucesso!';
    statusHistorico.style.color = '#2ecc71';
    resultadoEl.textContent = `Estrat√©gias criadas: ${estrategias.length}`;
    ultimoResultado = null;
    btnAcertou.disabled = true;
    btnErrou.disabled = true;
  }

  // Analisar sinal manual
  function analisarSinalManual() {
    const antNum = parseInt(document.getElementById('inputNumAnterior').value);
    const antHora = document.getElementById('inputHoraAnterior').value.trim();
    const brHora = document.getElementById('inputHoraBranco').value.trim();
    const posNum = parseInt(document.getElementById('inputNumPosterior').value);
    const posHora = document.getElementById('inputHoraPosterior').value.trim();

    if (isNaN(antNum) || !antHora || !brHora || isNaN(posNum) || !posHora) {
      resultadoEl.textContent = '‚ö†Ô∏è Preencha todos os campos do sinal manual.';
      return;
    }

    const antDt = parseHorario(antHora);
    const brDt = parseHorario(brHora);
    const posDt = parseHorario(posHora);
    if (!antDt || !brDt || !posDt) {
      resultadoEl.textContent = '‚ö†Ô∏è Hor√°rios inv√°lidos (use HH:mm:ss).';
      return;
    }

    const somaManual = antNum + posNum;
    const intervaloSegManual = (posDt - brDt) / 1000;

    let melhorEstrat = null;
    for (let e of estrategias) {
      if (
        Math.abs(e.soma - somaManual) <= 2 &&
        Math.abs(e.intervaloSeg - intervaloSegManual) <= 10
      ) {
        if (!melhorEstrat || e.peso > melhorEstrat.peso) {
          melhorEstrat = e;
        }
      }
    }

    if (!melhorEstrat) {
      resultadoEl.textContent = 'Nenhuma estrat√©gia similar encontrada para este sinal manual.';
      btnAcertou.disabled = true;
      btnErrou.disabled = true;
      ultimoResultado = null;
      return;
    }

    resultadoEl.innerHTML = `Estrat√©gia detectada:<br>
      Soma anterior+posterior: <b>${melhorEstrat.soma}</b><br>
      Intervalo segundos: <b>${melhorEstrat.intervaloSeg.toFixed(1)}</b><br>
      Peso: <b>${melhorEstrat.peso.toFixed(2)}</b><br>
      <br>
      <span style="color:${melhorEstrat.peso >= 1.5 ? '#e74c3c' : '#f39c12'}; font-weight:bold;">
        ${melhorEstrat.peso >= 1.5 ? 'SINAL FORTE' : 'SINAL FRACO'}
      </span>`;

    ultimoResultado = melhorEstrat;
    btnAcertou.disabled = false;
    btnErrou.disabled = false;
  }

  // Bot√£o acertou
  function sinalAcertou() {
    if (!ultimoResultado) return;
    const id = ultimoResultado.id;
    pesosEstrategias[id] = (pesosEstrategias[id] ?? 1) + 0.2;
    salvarEstrategias();
    statusGeral.textContent = 'üëç Estrat√©gia refor√ßada (Acertou).';
    statusGeral.style.color = '#2ecc71';
    btnAcertou.disabled = true;
    btnErrou.disabled = true;
    setTimeout(() => {
      statusGeral.textContent = '';
    }, 4000);
  }

  // Bot√£o errou
  function sinalErrou() {
    if (!ultimoResultado) return;
    const id = ultimoResultado.id;
    pesosEstrategias[id] = (pesosEstrategias[id] ?? 1) - 0.3;
    if (pesosEstrategias[id] < 0.2) pesosEstrategias[id] = 0.2;
    salvarEstrategias();
    statusGeral.textContent = '‚ö†Ô∏è Estrat√©gia enfraquecida (Errou).';
    statusGeral.style.color = '#e74c3c';
    btnAcertou.disabled = true;
    btnErrou.disabled = true;
    setTimeout(() => {
      statusGeral.textContent = '';
    }, 4000);
  }

  // Bot√£o limpar tudo
  function limparTudo() {
    if (confirm('Deseja limpar todo o hist√≥rico, estrat√©gias e pesos?')) {
      estrategias = [];
      pesosEstrategias = {};
      ultimoResultado = null;
      localStorage.clear();
      inputHistorico.value = '';
      resultadoEl.textContent = '';
      statusHistorico.textContent = '';
      statusGeral.textContent = '';
      btnAcertou.disabled = true;
      btnErrou.disabled = true;
    }
  }

  // Eventos
  btnAnalisarHistorico.onclick = analisarHistorico;
  btnAnalisarSinal.onclick = analisarSinalManual;
  btnAcertou.onclick = sinalAcertou;
  btnErrou.onclick = sinalErrou;
  btnLimparTudo.onclick = limparTudo;

  // Carregar estrat√©gias ao iniciar
  carregarEstrategias();
})();
</script>

</body>
</html>
