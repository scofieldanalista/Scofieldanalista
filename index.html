<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scofield Analista V3 PRO ‚ö™</title>
<style>
  body {
    background: #111;
    color: #eee;
    font-family: 'Segoe UI', sans-serif;
    padding: 15px;
  }
  h1 {
    text-align: center;
    color: #ff4747;
  }
  textarea,
  input,
  button {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    box-sizing: border-box;
  }
  textarea,
  input {
    background: #222;
    color: #eee;
    border: 1px solid #555;
  }
  button {
    background: #ff4747;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: bold;
  }
  button:hover {
    background: #e53e3e;
  }
  .secao {
    margin-top: 25px;
  }
  .sinal {
    background: #222;
    padding: 10px;
    margin-top: 10px;
    border-radius: 5px;
  }
  .sinal button {
    width: 48%;
    margin: 2px 1%;
    font-weight: bold;
  }
  .estatisticas {
    white-space: pre-line;
    background: #222;
    padding: 10px;
    border-radius: 5px;
    margin-top: 15px;
    font-size: 1em;
  }
  #avisoRecChuva {
    background: #440000;
    color: #ff5555;
    padding: 10px;
    text-align: center;
    border-radius: 5px;
    font-weight: bold;
    margin-bottom: 15px;
  }
  #proximaPrevisao {
    background: #330000;
    color: #ff4747;
    padding: 10px;
    text-align: center;
    border-radius: 5px;
    font-weight: bold;
    margin-bottom: 15px;
  }
</style>
</head>
<body>
<h1>Scofield Analista V3 PRO ‚ö™</h1>

<div id="proximaPrevisao">Pr√≥xima previs√£o forte: --:--:--</div>
<div id="avisoRecChuva"></div>

<div class="secao">
  <h3>üß† Hist√≥rico C√©rebro</h3>
  <textarea id="historicoCerebro" rows="8" placeholder="Cole aqui o hist√≥rico completo com hor√°rios, n√∫meros e cores..."></textarea>
  <button onclick="enviarCerebro()">üì§ Enviar Hist√≥rico</button>
  <div id="mensagemCerebro" style="color:#8f8; margin-top:6px;"></div>
  <div>Estrat√©gias criadas: <span id="numEstrategias">0</span></div>
</div>

<div class="secao">
  <h3>‚è±Ô∏è Come√ßar An√°lise</h3>
  <textarea id="historicoAtual" rows="6" placeholder="Cole aqui as √∫ltimas jogadas para prever os brancos..."></textarea>
  <button onclick="analisarAgora()">üîç Analisar</button>
  <div id="previsoes"></div>
  <button onclick="mostrarMinutosQuentes()" style="margin-top:10px;">üìà Ver Minutos Quentes</button>
  <div id="minutosQuentes" style="margin-top:10px; background:#222; padding:10px; border-radius:5px; max-height:150px; overflow:auto;"></div>
</div>

<div class="secao">
  <h3>üìä Estat√≠sticas</h3>
  <div id="estatisticas" class="estatisticas"></div>
  <button onclick="limparEstatisticas()">üßπ Limpar Estat√≠sticas</button>
</div>

<div class="secao">
  <h3>üßπ Limpar Hist√≥rico</h3>
  <button onclick="limparHistorico()">üßº Limpar Campos de Hist√≥rico</button>
  <div id="mensagemHistorico" style="margin-top:10px;color:#8f8;"></div>
</div>

<script>
  // Constants para cores
  const VERMELHAS = new Set(['1','2','3','4','5','6','7']);
  const PRETAS = new Set(['8','9','10','11','12','13','14']);

  // Dados salvos localmente
  let estrategias = JSON.parse(localStorage.getItem("estrategias") || "[]");
  let estatisticas = JSON.parse(localStorage.getItem("estatisticas") || "[]");
  let historicosMemorizados = JSON.parse(localStorage.getItem("historicosMemorizados") || "[]");

  // Atualiza contagem estrat√©gias na tela
  function atualizarContadorEstrategias(){
    document.getElementById("numEstrategias").innerText = estrategias.length;
  }

  // Salva no localStorage e atualiza estat√≠sticas e contador
  function salvarDados() {
    localStorage.setItem("estrategias", JSON.stringify(estrategias));
    localStorage.setItem("estatisticas", JSON.stringify(estatisticas));
    localStorage.setItem("historicosMemorizados", JSON.stringify(historicosMemorizados));
    atualizarEstatisticas();
    atualizarContadorEstrategias();
  }

  // Fun√ß√£o para parsear o hist√≥rico c√©rebro e transformar em array de objetos {num, hora, cor}
  function parsearHistorico(texto){
    let linhas = texto.trim().split(/\r?\n/).map(l => l.trim()).filter(l => l !== '');
    let resultado = [];
    for(let i=0; i<linhas.length;){
      // Normalmente cada entrada vem em 2 linhas: n√∫mero e hor√°rio, ou 1 linha para branco sem n√∫mero
      let num = linhas[i];
      let proxLinha = linhas[i+1] || '';
      if(/^\d{2}:\d{2}:\d{2}$/.test(num)){ // linha s√≥ hor√°rio, significa branco sem n√∫mero na linha anterior? Pode ser erro, ignorar
        i++;
        continue;
      }
      if(/^\d{2}:\d{2}:\d{2}$/.test(proxLinha)){
        // n√∫mero + hor√°rio
        let cor = 'branco';
        if(num === '0' || num === ''){
          cor = 'branco';
          num = null;
        } else if(VERMELHAS.has(num)){
          cor = 'vermelha';
        } else if(PRETAS.has(num)){
          cor = 'preta';
        } else {
          cor = 'desconhecida';
        }
        resultado.push({num: num, hora: proxLinha, cor: cor});
        i += 2;
      } else {
        // S√≥ n√∫mero, sem hor√°rio, ignorar
        i++;
      }
    }
    return resultado;
  }

  // Fun√ß√£o que cria ou atualiza estrat√©gias com base em hist√≥rico
  function criarOuAtualizarEstrategias(historicoParseado){
    // Estrat√©gia simplificada: memorizar os hor√°rios dos brancos (hor√°rio exato e minuto)
    // E identificar padr√µes simples de repeti√ß√µes e intervalos
    let novosHorariosBranco = [];
    historicoParseado.forEach(item => {
      if(item.cor === 'branco'){
        novosHorariosBranco.push(item.hora);
      }
    });

    // Verifica se padr√£o j√° existe em estrat√©gias
    let novaEstrategia = {
      id: Date.now(),
      horariosBrancos: novosHorariosBranco,
      criadoEm: Date.now(),
      peso: 1 // peso inicial para pondera√ß√£o
    };

    // Compara com as j√° existentes, se j√° tem um igual (exato ou similar), n√£o adiciona nova
    let igual = estrategias.some(est => {
      if(est.horariosBrancos.length !== novaEstrategia.horariosBrancos.length) return false;
      for(let i=0; i<est.horariosBrancos.length; i++){
        if(est.horariosBrancos[i] !== novaEstrategia.horariosBrancos[i]) return false;
      }
      return true;
    });

    if(!igual){
      estrategias.push(novaEstrategia);
      return 1; // uma estrat√©gia criada
    }
    return 0; // nenhuma criada, pois j√° existe
  }

  // Enviar hist√≥rico c√©rebro: parsear, criar estrat√©gia e memorizar hist√≥rico
  function enviarCerebro(){
    const texto = document.getElementById("historicoCerebro").value;
    if(texto.trim().length < 10){
      alert("Hist√≥rico muito curto.");
      return;
    }
    const parseado = parsearHistorico(texto);
    if(parseado.length === 0){
      alert("N√£o foi poss√≠vel interpretar o hist√≥rico.");
      return;
    }

    // Armazena hist√≥rico para comparar padr√µes
    historicosMemorizados.push({
      data: Date.now(),
      itens: parseado
    });

    // Cria estrat√©gia com base no hist√≥rico
    const criadas = criarOuAtualizarEstrategias(parseado);

    document.getElementById("mensagemCerebro").innerText = `‚úÖ Hist√≥rico enviado com sucesso! ${criadas} estrat√©gia(s) criada(s).`;

    salvarDados();
  }

  // Fun√ß√£o para verificar se um hor√°rio est√° dentro de um intervalo (ex: pr√≥ximo)
  function estaProximo(hora1, hora2, segundos=60){
    // hora formato "HH:MM:SS"
    let h1 = hora1.split(':').map(Number);
    let h2 = hora2.split(':').map(Number);
    let t1 = h1[0]*3600 + h1[1]*60 + h1[2];
    let t2 = h2[0]*3600 + h2[1]*60 + h2[2];
    return Math.abs(t1 - t2) <= segundos;
  }

  // Fun√ß√£o para analisar o hist√≥rico atual e prever os pr√≥ximos brancos usando as estrat√©gias salvas
  function analisarAgora(){
    const textoAtual = document.getElementById("historicoAtual").value;
    if(textoAtual.trim().length < 5){
      alert("Cole as √∫ltimas jogadas para analisar.");
      return;
    }
    const parseadoAtual = parsearHistorico(textoAtual);
    if(parseadoAtual.length === 0){
      alert("N√£o foi poss√≠vel interpretar o hist√≥rico atual.");
      return;
    }

    // Busca estrat√©gias compat√≠veis: aquelas que tem hor√°rios que aparecem no hist√≥rico atual
    let estrategiasCompativeis = estrategias.filter(est => {
      return est.horariosBrancos.some(hb => {
        // verifica se algum hor√°rio do padr√£o est√° pr√≥ximo do hor√°rio atual
        return parseadoAtual.some(item => {
          if(item.cor === 'branco'){
            return estaProximo(hb, item.hora, 60);
          }
          return false;
        });
      });
    });

    // Se n√£o achou estrat√©gia compat√≠vel, usa fallback simples
    let previsoes = [];
    let avisoRecChuva = "";
    if(estrategiasCompativeis.length === 0){
      avisoRecChuva = "üîç Nenhum padr√£o detectado. Usando previs√£o simples.";
      // Previs√£o simples: pr√≥ximo branco nos pr√≥ximos minutos (exemplo)
      let agora = new Date();
      for(let i=1; i<=3; i++){
        let novaHora = new Date(agora.getTime() + i*60000);
        let h = novaHora.getHours().toString().padStart(2,'0');
        let m = novaHora.getMinutes().toString().padStart(2,'0');
        let s = novaHora.getSeconds().toString().padStart(2,'0');
        previsoes.push({ horario: `${h}:${m}:${s}`, nivel: i===1?"Forte":i===2?"Moderado":"Arriscado" });
      }
    } else {
      // Escolhe a estrat√©gia com maior peso
      estrategiasCompativeis.sort((a,b) => b.peso - a.peso);
      let melhor = estrategiasCompativeis[0];

      // Previs√µes s√£o os hor√°rios brancos da estrat√©gia que ainda n√£o passaram e que fazem sentido com o hor√°rio atual
      let agoraSegundos = (() => {
        let d = new Date();
        return d.getHours()*3600 + d.getMinutes()*60 + d.getSeconds();
      })();

      previsoes = melhor.horariosBrancos.filter(hb => {
        let partes = hb.split(':').map(Number);
        let seg = partes[0]*3600 + partes[1]*60 + partes[2];
        return seg >= agoraSegundos;
      }).map(hb => {
        return {horario: hb, nivel: "Forte"};
      });

      avisoRecChuva = detectarRecOuChuva(parseadoAtual, melhor);
    }

    mostrarPrevisoes(previsoes, avisoRecChuva);
  }

  // Mostrar as previs√µes no DOM
  function mostrarPrevisoes(previsoes, avisoRecChuva){
    const div = document.getElementById("previsoes");
    div.innerHTML = "<h4>üü¢ Brancos Prov√°veis:</h4>";
    previsoes.forEach(p => {
      let linha = document.createElement("div");
      linha.style.marginBottom = "5px";

      linha.innerHTML = `
        ${p.horario} (${p.nivel})
        <button onclick="registrarAcerto('${p.horario}')">‚úÖ Acertou</button>
        <button onclick="registrarErro('${p.horario}')">‚ùå Errou</button>
      `;
      div.appendChild(linha);
    });

    // Atualiza o aviso autom√°tico do pr√≥ximo forte no topo
    if(previsoes.length > 0){
      document.getElementById("proximaPrevisao").innerText = `Pr√≥xima previs√£o forte: ${previsoes[0].horario}`;
    } else {
      document.getElementById("proximaPrevisao").innerText = "Pr√≥xima previs√£o forte: --:--:--";
    }

    // Aviso REC/CHUVA
    document.getElementById("avisoRecChuva").innerText = avisoRecChuva || "";
  }

  // Registrar acerto para a estrat√©gia associada ao hor√°rio
  function registrarAcerto(horario){
    estatisticas.push({ horario: horario, acerto: true, data: Date.now()});
    // Pode aumentar peso da estrat√©gia que prev√™ este hor√°rio
    ajustarPesoEstrategia(horario, true);
    salvarDados();
    atualizarEstatisticas();
  }

  // Registrar erro para a estrat√©gia associada ao hor√°rio
  function registrarErro(horario){
    estatisticas.push({ horario: horario, acerto: false, data: Date.now()});
    // Pode diminuir peso da estrat√©gia que prev√™ este hor√°rio
    ajustarPesoEstrategia(horario, false);
    salvarDados();
    atualizarEstatisticas();
  }

  // Ajusta o peso da estrat√©gia que contem o hor√°rio
  function ajustarPesoEstrategia(horario, acertou){
    estrategias.forEach(est => {
      if(est.horariosBrancos.includes(horario)){
        if(acertou) est.peso += 1;
        else est.peso = Math.max(1, est.peso - 1);
      }
    });
  }

  // Atualiza as estat√≠sticas na tela
  function atualizarEstatisticas(){
    const div = document.getElementById("estatisticas");
    if(estatisticas.length === 0){
      div.innerText = "Nenhuma estat√≠stica registrada.";
      return;
    }
    let linhas = estatisticas.map(e => {
      let status = e.acerto ? "‚úÖ" : "‚ùå";
      let d = new Date(e.data);
      let dataStr = d.toLocaleString();
      return `${e.horario} ${status} - ${dataStr}`;
    });
    div.innerText = linhas.join('\n');
  }

  // Limpar estat√≠sticas
  function limparEstatisticas(){
    estatisticas = [];
    salvarDados();
    atualizarEstatisticas();
  }

  // Limpar campos de hist√≥rico e mensagens
  function limparHistorico(){
    document.getElementById("historicoCerebro").value = "";
    document.getElementById("historicoAtual").value = "";
    document.getElementById("mensagemCerebro").innerText = "";
    document.getElementById("mensagemHistorico").innerText = "‚úÖ Campos de hist√≥rico limpos!";
    document.getElementById("previsoes").innerHTML = "";
    document.getElementById("avisoRecChuva").innerText = "";
    document.getElementById("proximaPrevisao").innerText = "Pr√≥xima previs√£o forte: --:--:--";
  }

  // Mostrar minutos quentes ‚Äî combina todos os hor√°rios brancos das estrat√©gias ordenados e sem repeti√ß√£o
  function mostrarMinutosQuentes(){
    let todosHorarios = [];
    estrategias.forEach(est => {
      todosHorarios = todosHorarios.concat(est.horariosBrancos);
    });
    // Remove duplicados e ordena
    let unicos = [...new Set(todosHorarios)];
    unicos.sort();

    let div = document.getElementById("minutosQuentes");
    if(unicos.length === 0){
      div.innerText = "Nenhum minuto quente aprendido ainda.";
      return;
    }
    div.innerText = unicos.join("\n");
  }

  // Detecta padr√µes REC ou CHUVA baseado no hist√≥rico atual e estrat√©gia
  function detectarRecOuChuva(historicoAtual, estrategia){
    // REC: poucos brancos num per√≠odo prolongado, padr√£o de baixa frequ√™ncia
    // CHUVA: muitos brancos em sequ√™ncia curta, padr√£o alta frequ√™ncia

    // Conta brancos no hist√≥rico atual
    let totalBrancos = historicoAtual.filter(i => i.cor === 'branco').length;

    // Padr√£o: Se estrat√©gia tem muitos brancos pr√≥ximos e no hist√≥rico atual poucos, pode ser REC
    // Se estrat√©gia tem poucos brancos e no hist√≥rico atual muitos pr√≥ximos, pode ser CHUVA

    let estrategiaQtd = estrategia.horariosBrancos.length;

    // Checa intervalo entre brancos na estrat√©gia e no atual (simplificado)
    let intervalosEstr = [];
    for(let i=1; i<estrategia.horariosBrancos.length; i++){
      intervalosEstr.push(diffSegundos(estrategia.horariosBrancos[i-1], estrategia.horariosBrancos[i]));
    }
    let mediaIntervaloEstr = intervalosEstr.length > 0 ? (intervalosEstr.reduce((a,b)=>a+b,0)/intervalosEstr.length) : 60;

    // Hist atual: calcula m√©dia intervalo entre brancos
    let brancosAtual = historicoAtual.filter(i=>i.cor==='branco');
    let intervalosAtual = [];
    for(let i=1; i<brancosAtual.length; i++){
      intervalosAtual.push(diffSegundos(brancosAtual[i-1].hora, brancosAtual[i].hora));
    }
    let mediaIntervaloAtual = intervalosAtual.length > 0 ? (intervalosAtual.reduce((a,b)=>a+b,0)/intervalosAtual.length) : 60;

    // Se m√©dia intervalo atual muito maior que da estrat√©gia, sinaliza REC
    if(mediaIntervaloAtual > mediaIntervaloEstr * 1.5 && totalBrancos < estrategiaQtd * 0.5){
      return "‚ö†Ô∏è Padr√£o REC detectado (baixa frequ√™ncia de brancos)";
    }

    // Se m√©dia intervalo atual muito menor e mais brancos, sinaliza CHUVA
    if(mediaIntervaloAtual < mediaIntervaloEstr * 0.7 && totalBrancos > estrategiaQtd * 1.5){
      return "‚ö†Ô∏è Padr√£o CHUVA detectado (alta frequ√™ncia de brancos)";
    }

    return "";
  }

  // Diferen√ßa em segundos entre duas horas "HH:MM:SS"
  function diffSegundos(h1,h2){
    let p1 = h1.split(':').map(Number);
    let p2 = h2.split(':').map(Number);
    let t1 = p1[0]*3600 + p1[1]*60 + p1[2];
    let t2 = p2[0]*3600 + p2[1]*60 + p2[2];
    return Math.abs(t2 - t1);
  }

  // Inicializa√ß√£o
  atualizarEstatisticas();
  atualizarContadorEstrategias();
</script>
</body>
</html>
